<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Attendance</title>
<link rel="manifest" href="manifest.json">
<style>
 body{font-family:Arial;padding:20px;background:#f7f8fa}
 .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,0.08);margin-bottom:12px}
 button{padding:10px 14px;background:#0b79d0;color:#fff;border:0;border-radius:6px}
</style>
</head>
<body>
  <div class="card">
    <h3>Driver Attendance</h3>
    <p><b>Driver:</b> <span id="driverDisplay">—</span></p>
    <div id="nameArea">
      <input id="driverName" placeholder="Enter your name" style="padding:10px;width:100%;margin-top:10px">
      <div style="height:10px"></div>
      <button id="saveName">Save name</button>
    </div>
    <div id="msg" style="margin-top:12px;color:green"></div>
    <div id="err" style="margin-top:12px;color:red"></div>
  </div>

<script>
  // CONFIG - replace WEB_APP_URL after deploying Apps Script
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzyrnoZnI7XsqAHvo8JYoF1Sl70MrDNEPNTXjaFTJ0hnAcizQF5T9C8DbDiKQiM4ooB/exec";
  const SECRET_TOKEN = "rT7v9Kp3LmQ2Zx8VbH1sF4NcY6Ua0WqP";

  const key = "driverName";
  const dDisp = document.getElementById("driverDisplay");
  const nameArea = document.getElementById("nameArea");
  const msg = document.getElementById("msg");
  const err = document.getElementById("err");
  const nameInp = document.getElementById("driverName");

  function setDriverUI(n){
    if(n){ dDisp.textContent = n; nameArea.style.display='none'; }
    else{ dDisp.textContent='—'; nameArea.style.display='block'; }
  }
  setDriverUI(localStorage.getItem(key));
  document.getElementById("saveName").onclick = function(){
    const v = nameInp.value.trim();
    if(!v){ alert("Enter name"); return; }
    localStorage.setItem(key, v);
    setDriverUI(v);
  };

  // get car from URL
  const params = new URLSearchParams(window.location.search);
  if(params.has('car')){
    const car = params.get('car');
    const driver = localStorage.getItem(key);
    if(driver){
      send(car, driver);
    } else {
      // when user saves name, send automatically
      document.getElementById("saveName").onclick = function(){
        const v = nameInp.value.trim();
        if(!v){ alert("Enter name"); return; }
        localStorage.setItem(key, v);
        setDriverUI(v);
        send(car, v);
      };
    }
  }

  async function send(car, driver){
    err.textContent = '';
    msg.textContent = 'Sending...';
    try{
      const url = WEB_APP_URL + '?car=' + encodeURIComponent(car) + '&driver=' + encodeURIComponent(driver) + '&tok=' + encodeURIComponent(SECRET_TOKEN);
      // inside your send(car, driver) function, after fetch
      const r = await fetch(url);
      const txt = await r.text();
      if(!r.ok){
        err.textContent = 'Server error: ' + txt;
        msg.textContent = '';
        return;
      }
      let j = null;
      try { j = JSON.parse(txt); } catch(e) { j = null; }
      
      if (j && j.status === 'ok') {
        // sheetTime is ISO string of exact cell saved in sheet
        const sheetTime = j.sheetTime ? new Date(j.sheetTime) : new Date();
        const niceSheetTime = sheetTime.toLocaleString([], { hour: '2-digit', minute: '2-digit', year:'numeric', month:'short', day:'numeric' });
      
        if (j.action === 'in') {
          msg.textContent = 'Recorded IN at ' + niceSheetTime;
        } else if (j.action === 'out') {
          let lastInNice = '(no IN found)';
          if (j.lastInSheetTime) {
            const lastIn = new Date(j.lastInSheetTime);
            lastInNice = lastIn.toLocaleString([], { hour: '2-digit', minute: '2-digit', year:'numeric', month:'short', day:'numeric' });
          }
          msg.textContent = 'Recorded OUT at ' + niceSheetTime + ' (IN: ' + lastInNice + ')';
        } else {
          msg.textContent = 'Recorded at ' + niceSheetTime;
        }
      } else {
        err.textContent = 'Unexpected response: ' + txt;
      }
    }
</script>
</body>
</html>
